pipeline{

    environment{
                    VERSION = "${env.BUILD_ID}"
                }


    agent{

        docker{
            image 'abhishekf5/maven-abhishek-docker-agent:v1'
            args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
             }
    }

    stages{

             stage('Build and Test') {

                steps {

                     sh 'ls -ltr'
                     // build the project and create a JAR file
                    sh  'mvn clean package'
                 }
            }
            stage('sonar quality status'){

              environment {
        
                SONAR_URL = "http://54.242.225.45:9000"

                    }
            
                 steps{

                     withCredentials([string(credentialsId: 'sonar-token', variable: 'sonar_token')]) {

                      sh 'mvn sonar:sonar -Dsonar.login=$sonar_token -Dsonar.host.url=${SONAR_URL}'
        
                         }
  
                    }
            }
            // pushing image to nexus repo

            stage('docker build and push to nexus repo'){

                
                steps{

                    script{

                        withCredentials([string(credentialsId: 'nexus_passwd', variable: 'nexus_creds')]) {
    
                          sh '''
                              docker build -t 18.206.38.226:8083/spring app:${VERSION} .
                              docker login -u admin -p $nexus_creds 18.206.38.226:8083
                              docker push 18.206.38.226:8083/spring app:${VERSION}
                              docker rmi 18.206.38.226:8083/spring app:${VERSION}


                            '''

                        }

                    }
                }
            }

        }
    }
